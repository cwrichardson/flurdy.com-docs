<!DOCTYPE html>
<html>

<head>
   <title>Install CockroachDB on Kubernetes</title>
   <meta name="description"
      content="Step by step guid to install CockroachDB in a Kubernetes cluster">
   <meta name="keywords" content="cockroach,cockroachdb,kubernetes,helm,fluxcd">
   <link rel="shortcut icon" href="/favicon.ico">
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <script defer src="https://use.fontawesome.com/releases/v5.8.2/js/all.js"
      integrity="sha384-DJ25uNYET2XCl5ZF++U8eNxPWqcKohUUBUpKGlNLMchM7q4Wjg2CUpjHLaL8yYPH" crossorigin="anonymous"></script>
   <link rel="stylesheet" href="assets/plugins/bootstrap/css/bootstrap.min.css">
   <link rel="stylesheet" href="assets/plugins/prism/prism.css">
   <link rel="stylesheet" href="assets/plugins/elegant_font/css/style.css">
   <link id="theme-style" rel="stylesheet" href="assets/css/styles.css">
   <link href="docs.css" rel="stylesheet" type="text/css" />
   <script>
      (function (i, s, o, g, r, a, m) {
         i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
         }, i[r].l = 1 * new Date(); a = s.createElement(o),
            m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
      })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

      ga('create', 'UA-281408-1', 'auto');
      ga('send', 'pageview');
   </script>

   <!-- <meta http-equiv="REFRESH" content="15;"> -->

</head>

<body>
   <div class="page-wrapper">

      <header id="header" class="header">
         <div class="container">
            <div class="branding">
               <h1 class="logo">
                  <a href="index.html">
                     <a href="http://flurdy.com"><img id="flurdy" src="/images/flurdy_warped_dual.png" alt="flurdy" /></a>
                     <a href="http://flurdy.com/docs"><span class="text-bold">Docs</span></a>
                  </a>
               </h1>

            </div>
         </div>
      </header>


        <div class="doc-wrapper">
            <div class="container">
                <div id="doc-header" class="doc-header text-center">
                    <h1 class="doc-title"><i class="icon fa fa-database"></i> Install CockroachDB on Kubernetes</h1>
                    <div class="meta"><i class="far fa-clock"></i>
                      First published: March 2020.  Last updated: March 2020
                    </div>
                    <div class="meta"><i class="fas fa-edit"></i>
                      Author: Ivar Abrahamsen <a href="https://twitter.com/flurdy">@flurdy</a>
                    </div>
                </div>

                <div class="doc-body row">
                    <div class="doc-content col-md-9 col-12 order-1">
                        <div class="content-inner">

                           <!--
                              <div class="callout-block callout-warning">
                                 <div class="icon-holder">
                                    <i class="fas fa-info-circle"></i>
                                 </div>
                                 <div class="content">
                                    <h4 class="callout-title">Draft</h4>
                                    <p>
                                       This is an early draft.
                                       May still miss sections,
                                       bad links,
                                       no references,
                                       unverified code,
                                       babble not yet pruned,
                                       and full of typos and spelling errors.
                                    </p>
                                    <p>
                                       This is also a new document template,
                                       so will be tweaked and cruft removed.
                                    </p>
                                 </div>
                              </div>
                           -->

                              <div class="callout-block callout-info">
                                 <div class="icon-holder">
                                    <i class="fas fa-info-circle"></i>
                                 </div>
                                 <div class="content">
                                    <h4 class="callout-title">Recently published</h4>
                                    <p>
                                       There might still be some paragraphs that needs rewording.
                                    </p>
                                    <p>
                                       Please <a href="https://github.com/flurdy/flurdy.com-docs">fork</a>
                                       and send a small PR if spot any typos.
                                    </p>
                                 </div>
                              </div>

                            <section id="synopsis-section" class="doc-section">
                                <h2 class="section-title">What is this?</h2>
                                <div class="section-block">

                                    <div class="row">
                                       <div class="col-md-10 col-12">
                                          <ul>
                                             <li>A step by step instructions to install <a href="https://www.cockroachlabs.com/product/">CockroachDB</a> in to a <a
                                                href="https://kubernetes.io">Kubernetes</a> cluster.</li>
                                             <li>Setting up secure communication between nodes,
                                             and clients.</li>
                                             <li>Installed using <a href="https://helm.sh/">Helm</a> packages.</li>
                                             <li>Optionally managed with <a href="https://fluxcd.io/">FluxCD</a>.</li>
                                          </ul>
                                       </div>
                                    </div>
                                </div>
                            </section>

                            <section id="cockroach-section" class="doc-section">
                                <h2 class="section-title">CockroachDB</h2>
                                <div id="cockroach-what" class="section-block">
                                   <h3>What is CockroachDB?</h3>
                                   <p>
                                      CockroachDB is a fault tolerant database that scales horiontally for reliability.
                                      It can self heal and recover from lost nodes.
                                      Its SQL is <a href="https://www.postgresql.org/">Postgresql</a> compatible.
                                   </p>
                                </div>
                                <div id="cockroach-why" class="section-block">
                                   <h3>Why CockroachDB</h3>
                                   <p>
                                       It has been proven to be reliable and production ready.
                                       The Postgres compatibility means it can easily be dropped into
                                       application already using Postgres.
                                   </p>
                                   <p>
                                      As a heavy user of Postgres it seems an easy transition for the architecture that I work with.
                                   </p>
                                </div>
                            </section>

                            <section id="prerequisite-section" class="doc-section">
                                <h2 class="section-title">Pre-requisite</h2>
                                <div id="pre-k8s"  class="section-block">
                                    <h3 class="block-title">Kubernetes cluster</h3>
                                    <p>
                                       You can install CockroachDB on your own hardware and many other options but this guide covers running in a Kubernetes cluster.
                                    </p>
                                    <p>
                                       Feel free create a cluster with one of the managed service by the big cloud providers,
                                       another 3rd party provider
                                       or roll your own.
                                    </p>
                                    <p>Refer to the <a href="#references">provider references for options</a></p>

                                    <div class="callout-block callout-info">
                                       <div class="icon-holder">
                                          <i class="fas fa-info-circle"></i>
                                       </div>
                                       <div class="content">
                                          <h4 class="callout-title">Node sizes</h4>
                                          <p>
                                             CockroachDB is quite resource intensive.
                                          </p>
                                          <p>
                                             Cockroach examples suggest reserving 8GB per pod (node),
                                             starting with 3 pod replicas.
                                             My setup scales this back to 4GB on 2 pods.
                                          </p>
                                          <p>
                                             Note your nodes also needs capacity for your applications
                                             and Kubernetes own bundled pods.
                                          </p>
                                       </div>
                                    </div>

                                </div>

                                <div id="pre-kubectl" class="section-block">
                                    <h3 class="block-title">Kubernetes CLI</h3>
                                    <p>
                                       You need the CLI for Kubernetes, <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">kubectl</a>, installed locally,
                                       and configured to talk to your cluster.
                                    </p>
                                    <p>Refer to the <a href="#references">provider CLI references</a> for easy provider credentials</p>

                                    <div class="code-block">
                                       <h6>macOS:</h6>
                                       <pre><code class="language-bash">brew install kubernetes-cli</code></pre>
                                       <h6>Ubuntu:</h6>
                                       <pre><code class="language-bash">sudo snap install kubectl --classic</code></pre>
                                    </div>

                                </div>

                                <div id="pre-helm" class="section-block">
                                    <h3 class="block-title">Helm</h3>
                                    <p>
                                       This set up assumes <a href="https://helm.sh">Helm</a> is used directly or via Flux
                                       to install packages into Kubernetes.
                                    </p>

                                    <div class="code-block">
                                       <h6>macOS:</h6>
                                       <pre><code class="language-bash">brew install helm</code></pre>
                                    </div>
                                    <p>
                                       And then install the stable chart repository.
                                    </p>
                                    <div class="code-block">
                                       <pre><code class="language-bash">helm repo add stable \
   https:// kubernetes-charts.storage.googleapis.com/</code></pre>
                                    </div>
                                    <p>
                                       You can install CockroachDB without Helm,
                                       but it requires more steps.
                                       Full details are available in the <a href="https://www.cockroachlabs.com/docs/stable/">CockroachDB documentation</a>.
                                    </p>
                                </div>

                                <div id="pre-flux" class="section-block">
                                    <h3 class="block-title">FluxCD</h3>
                                    <p>
                                       Optional.
                                       <a href="https://fluxcd.io">FluxCd</a> is a way to manage a cluster via GitOps.
                                    </p>
                                    <p>
                                       For help setting up Flux have a look at my <a href="https://github.com/flurdy/lemmings">Lemmings</a> repository.
                                    </p>
                                </div>

                            </section>

                            <section id="install-section" class="doc-section">

                                <h2 class="section-title">Install</h2>

                              <div class="callout-block callout-info">
                                 <div class="icon-holder">
                                    <i class="fas fa-info-circle"></i>
                                 </div>
                                 <div class="content">
                                    <h4 class="callout-title">GKE-only additional step</h4>
                                    <p>
                                       GKE require an additional RBAC,
                                       that contains the email address of your Google Cloud account.
                                    </p>
                                    <pre><code class="language-bash">gcloud info | grep Account</code></pre>
                                    <pre><code class="language-bash">kubectl create clusterrolebinding \
  <em>gcp-admin-binding</em> --clusterrole=cluster-admin \
  --user=<em>your.google.cloud.email@example.org</em> \
  --dry-run -o yaml &gt; cockroach/rbac-cockroach.yml</code></pre>
                                 </div>
                              </div>

                                <div id="install-helm"  class="section-block">
                                    <h3 class="block-title">Via Helm</h3>

                                    <p>
                                       Installing the CockroachDB package directly via Helm. (not using Flux)
                                    </p>

                                    <div class="callout-block callout-info">
                                       <div class="icon-holder">
                                          <i class="fas fa-info-circle"></i>
                                       </div>
                                       <div class="content">
                                          <h4 class="callout-title">GKE-only additional step</h4>
                                          <pre><code class="language-bash">kubectl apply -f cockroach/rbac-cockroach.yml</code></pre>
                                       </div>
                                    </div>

                                    <p>
                                       You need to specify some custom memory related values for the database.
                                    </p>
                                    <pre><code class="language-bash">vi cockroach/my-roach-values.yml</code></pre>

                                    <div class="code-block">
                                    <pre><code class="language-yaml">statefulset:
  replicas: 3
  resources:
    limits:
      memory: "4Gi"
    requests:
      memory: "4Gi"
conf:
  cache: "1024Mi"
  max-sql-memory: "1024Mi"</code></pre></div>

                                    <div class="code-block">
                                       <pre><code class="language-bash">helm install myroach \
   --values cockroach/my-roach-values.yaml stable/cockroachdb</code></pre>
                                </div>
                                <div id="install-flux"  class="section-block">
                                    <h3 class="block-title">FluxCD &amp; Helm</h3>
                                    <p>
                                       Alternatively if you use Flux and <a href="https://github.com/fluxcd/helm-operator">HelmOperator</a>,
                                       you can create a <em>HelmRelease</em> file.
                                       It includes the custom values similar to directly with Helm.
                                    </p>

                                    <div class="callout-block callout-info">
                                       <div class="icon-holder">
                                          <i class="fas fa-info-circle"></i>
                                       </div>
                                       <div class="content">
                                          <h4 class="callout-title">GKE additional step</h4>
                                          <pre><code class="language-bash">git add cockroach/rbac-cockroach.yml</code></pre>
                                       </div>
                                    </div>

                                    <div class="code-block">
                                       <pre><code class="language-shell">vi cockroach/helm-cockroach.yml</code></pre>
                                    </div>
                                    <div class="code-block">
                                       <pre><code class="language-yaml">apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: cockroachdb
  annotations:
    fluxcd.io/automated: "false"
spec:
  releaseName: myroach
  chart:
    repository: https://kubernetes-charts.storage.googleapis.com
  name: cockroachdb
  version: 3.0.6
  values:
    statefulset:
      replicas: 3
      resources:
        limits:
          memory: "4Gi"
        requests:
          memory: "4Gi"
    conf:
      cache: "1024Mi"
      max-sql-memory: "1024Mi"
  tls:
    enabled: true</code></pre>
                                    </div>

                                    <div class="code-block">
                                       <pre><code class="language-git">git add cockroach/helm-cockroach.yml</code></pre>
                                    </div>
                                </div>



                                <div id="install-pods"  class="section-block">
                                    <h3 class="block-title">Pods and volumes</h3>
                                    <p>
                                       The Helm chart should create 3 replica node pods,
                                       and one side-car init container pod.
                                    </p>
                                    <pre class="language-bash"><code class="language-bash">kubectl get pods</code></pre>
                                    <p>
                                       Initially they will all fail as you need to approve the CSRs.
                                    </p>
                                    <pre class="command-line language-bash" data-prompt=" " data-output="1-4"><code class="language-bash">NAME                           READY STATUS                RESTARTS AGE
myroach-cockroachdb-0          0/1   Init:0/1              0        2m19s
myroach-cockroachdb-1          0/1   Init:0/1              0        2m19s
myroach-cockroachdb-init-j2dgc 0/1   Init:CrashLoopBackOff 4        3m3s</code></pre>

                                    <p>
                                       You can also check that the statefulset have the required 100GB volumes,
                                       and that a public and private service has been created.
                                    </p>
                                    <pre><code class="language-shell">kubectl get pvc,pv,services</code></pre>

                                </div>

                                <div id="install-certs"  class="section-block">
                                    <h3 class="block-title">Node certificates</h3>
                                    <p>
                                       You need to review and approve the CSRs that each node has created to allow them to talk to each other.
                                    </p>

                                    <pre><code class="language-shell">kubectl get csr</code></pre>

                                    <pre class="command-line language-bash" data-prompt=" " data-output="1-4"><code class="language-bash">NAME                               AGE   REQUESTOR CONDITION
default.client.root                10m   s...b     Pending
default.node.myroach-cockroachdb-0 8m15s s...b     Pending
default.node.myroach-cockroachdb-1 8m29s s...b     Pending</code></pre>

                                    <pre><code class="language-shell">kubectl describe csr default.node.myroach-cockroachdb-0</code></pre>

                                    <p>
                                       If it seems okay, then approve the request:
                                    </p>

                                    <pre><code class="language-shell">kubectl certificate approve default.node.myroach-cockroachdb-0</code></pre>

                                    <p>
                                       And do the same to <em>default.node.myroach-cockroachdb-1</em>.
                                    </p>

                                    <pre class="command-line language-bash" data-prompt=" " data-output="1-4"><code class="language-bash">NAME                               AGE   REQUESTOR CONDITION
default.client.root                10m   s...b     Pending
default.node.myroach-cockroachdb-0 8m15s s...b     Approved,Issued
default.node.myroach-cockroachdb-1 8m29s s...b     Approved,Issued</code></pre>

                                    <p>
                                       Once the pods are up and running you can inspect and approve
                                       the <em>default.client.root</em> CSR as well.
                                       Now the init container can also communicate with the db pods.
                                    </p>


                                    <div class="callout-block callout-danger">
                                       <div class="icon-holder">
                                          <i class="fas fa-exclamation-triangle"></i>
                                       </div>
                                       <div class="content">
                                          <h4 class="callout-title">Pods still crashing</h4>
                                          <p>
                                             This is the woolly bit.
                                             For me the Pods will still not launch properly.
                                             Sometimes they start but not after many rounds of:
                                          </p>
                                          <ul>
                                             <li>tweaking memory requests limits</li>
                                             <li>deleting and recreating pods</li>
                                             <li>deleting, recreating and re-approving CSRs</li>
                                             <li>deleting and recreating PV & PVCs</li>
                                             <li>uninstalling and reinstalling the helm charts</li>
                                             <li>removing and re-adding the HelmRelease files</li>
                                          </ul>
                                          <p>
                                             I don't know why this fails even though the CSRs have been approved.
                                             And why they eventually after enough random prodding they sometimes work.
                                             This was the case on GKE, and currently not yet working in AKS.
                                             I will update this with the specific solution later.
                                          </p>
                                       </div>
                                    </div>

                                </div>
                           </section>

                            <section id="database-section" class="doc-section">
                                <h2 class="section-title">Database setup</h2>
                                <div id="database-connect"  class="section-block">
                                    <h3 class="block-title">Root connection</h3>
                                    <p>
                                       You need to set up a client connection for you to access the database as the root user.
                                       This uses the root client certificate.
                                    </p>
                                    <pre><code class="language-yaml">apiVersion: apps/v1
kind: Pod
metadata:
  name: <em>myroach</em>-client-secure
  labels:
    app: <em>myroach</em>-client
spec:
  serviceAccountName: <em>myroach</em>
  initContainers:
  - name: init-certs
    image: cockroachdb/cockroach-k8s-request-cert:0.4
    imagePullPolicy: IfNotPresent
    command:
    - "/bin/ash"
    - "-ecx"
    - "/request-cert -user=root -namespace=${POD_NAMESPACE} -certs-dir=/cockroach-certs -type=client -symlink-ca-from=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
    env:
    - name: POD_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
    volumeMounts:
    - name: client-certs
      mountPath: /cockroach-certs
  containers:
  - name: <em>myroach</em>-client
    image: cockroachdb/cockroach:v19.2.4
    imagePullPolicy: IfNotPresent
    volumeMounts:
    - name: client-certs
      mountPath: /cockroach-certs
    command:
    - sleep
    - "2147483648" # 2^31
  terminationGracePeriodSeconds: 0
  volumes:
  - name: client-certs
    emptyDir: {}</code></pre>
                                    <p>
                                       Apply it to your cluster and check the CSRs and approve the certificate if not already approved.
                                    </p>
                                    <pre><code class="language-shell">kubectl get csr</code></pre>

                                    <p>
                                       You can now connect to the database with:
                                    </p>
                                    <pre><code class="language-shell">kubectl exec -it <em>myroach</em>-client-secure \
  -- ./cockroach sql \
  --certs-dir=/cockroach-certs \
  --host=<em>myroach</em>-public</code></pre>
                                </div>
                                <div id="database-create"  class="section-block">
                                    <h3 class="block-title">Create database, user and grants</h3>
                                    <p>

                                    </p>
                                    <pre><code class="language-sql">CREATE DATABASE <em>myappdb</em>;
CREATE USER <em>myappuser</em> WITH PASSWORD 'somerandompassword';
GRANT CREATE,DROP ON DATABASE <em>myappdb</em> TO <em>myappuser</em>;</code></pre>

                                    <p>
                                       If you later on want to use the <a href="https://www.cockroachlabs.com/docs/stable/admin-ui-access-and-navigate.html">Cockroach Admin UI</a> with this user,
                                       you need to add a <em>admin</em> role to it:
                                    </p>
                                    <pre><code class="language-sql">INSERT INTO system.role_members (role, member, "isAdmin")
VALUES ('admin', '<em>myappuser</em>', true);</code></pre>

                                    <p>
                                       If you get grant permission problems later on, consider this:
                                    </p>
                                    <pre><code class="language-sql">SHOW GRANTS ON DATABASE <em>myappdb</em>;
GRANT ALL ON TABLE <em>myappdb</em>.* TO <em>myappuser</em>;
GRANT ALL ON SEQUENCE <em>myappdb</em>.* TO <em>myappuser</em>;
SHOW GRANTS ON TABLE <em>myappdb</em>.*;</code></pre>
                                </div>
                           </section>

                            <section id="client-section" class="doc-section">
                                <h2 class="section-title">Clients</h2>
                                <div id="client-certs"  class="section-block">
                                    <h3 class="block-title">Client pod certificates</h3>



                                    <div class="callout-block callout-warning">
                                       <div class="icon-holder">
                                          <i class="fas fa-frown"></i>
                                       </div>
                                       <div class="content">
                                          <h4 class="callout-title">Certificate required</h4>
                                          <p>
                                             For every database user for every application pod,
                                             you need to create a CSR.
                                          </p>
                                          <p>
                                             Whilst not a difficult setup it does mean automation and use of CockroachDB is trickier for little security theater gain.
                                          </p>
                                       </div>
                                    </div>

                                    <p>
                                       The certificate creation is done by inlining an init container per pod/deployment.
                                       Similar to the root connection earlier but with a different username, and no need for a CockroachDB client container.
                                    </p>
                                    <pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
...
spec:
  ...
    spec:
      serviceAccountName: <em>myroach</em>
      volumes:
      - name: client-certs
        emptyDir: {}
      initContainers:
      - name: init-certs
        image: cockroachdb/cockroach-k8s-request-cert:0.4
        imagePullPolicy: IfNotPresent
        command:
        - "/bin/ash"
        - "-ecx"
        - "/request-cert -user=<em>myappuser</em> -namespace=${POD_NAMESPACE} -certs-dir=/cockroach-certs -type=client -symlink-ca-from=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
        env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        volumeMounts:
        - name: client-certs
          mountPath: /cockroach-certs
      containers:
        ...</code></pre>

                                    <p>
                                       If you scroll along the <em>/request-cert</em> line you will eventually see <em>-user=myappuser</em>.
                                       Replace the <em>myappuser</em> with the database user you created.
                                    </p>
                                    <p>Then in the same file, with your normal container you then add a volume mount</p>
                                    <pre><code class="language-yaml">...
containers:
- name: <em>myapp-container</em>
   ...
   volumeMounts:
   - name: client-certs
      mountPath: /cockroach-certs
   ...</code></pre>

                                    <p>Once applied you can then approve the CSR</p>

                                    <pre><code class="language-bash">kubectl get csr</code></pre>
                                </div>

                                <div id="client-connection"  class="section-block">
                                    <h3 class="block-title">Database connection</h3>

                                    <p>
                                       Once the certificate is approved we can use it with the client connection to the database.
                                       This is mostly done via environment variables in the same Kubernetes deployment file used above.
                                    </p>

                                    <div class="callout-block callout-warning">
                                       <div class="icon-holder">
                                          <i class="fas fa-exclamation-triangle"></i>
                                       </div>
                                       <div class="content">
                                          <h4 class="callout-title">Secrets</h4>
                                          <p>
                                             How you deal with secrets in your Kubernetes cluster is up to you.
                                          </p>
                                          <p>
                                             Below we will just inline the credentials.
                                             This is terrible and for emphasising the other parts only.
                                             Never expose this in plain text in a real cluster.
                                             <!-- Never expose credentials in plain text -->
                                          </p>
                                          <p>
                                             Instead you should use <a href="https://kubernetes.io/docs/tasks/inject-data-application/distribute-credentials-secure/">Kubernetes Secrets</a>, <a href="https://github.com/bitnami-labs/sealed-secrets/">Sealed Secrets</a> or <a href="https://www.vaultproject.io/">Vault</a>, etc.
                                          </p>
                                       </div>
                                    </div>

                                    <p>
                                       In the app <em>myapp</em> it is listening to the environment variables <em>DB_DRIVER</em>, <em>DB_URL</em>, <em>DB_USERNAME</em> and <em>DB_PASSWORD</em>. This specifics of this will depend on your own application stack.
                                    </p>

                                    <pre><code class="language-yaml">...
containers:
- name: <em>myapp-container</em>
   ...
   env:
   - name: DB_DRIVER
      value: org.postgresql.Driver
   - name: DB_URL
      value: jdbc:postgresql://<em>myroach</em>-public:26257/<em>myappdb</em>?sslmode=require&sslcert=/cockroach-certs/client.<em>myappuser</em>.crt&sslkey=/cockroach-certs/client.<em>myappuser</em>.key"
   - name: DB_USERNAME
     value: <em>myappuser</em>
     - name: DB_PASSWORD
     value: <em>somerandompassword</em>
   ...</code></pre>

                                   <p>
                                      If you scroll along the Postgres URL you will see it connects to <em>myroach-public</em> service,
                                      the <em>myappdb</em> database,
                                      and uses the <em>myappuser</em> specific crt and key files.
                                   </p>
                                   <p>
                                      If you apply this, then this should be it. Your CockroachDB is now up and running. Hopefully.
                                   </p>
                                </div>
                           </section>

                            <section id="evaluation-section" class="doc-section">
                                <h2 class="section-title">Evaluation</h2>
                                <div class="section-block">
                                 <p>
                                    How did I find setting up CockroachDB?
                                 </p>
                                </div>
                                <div id="evaluation-pros"  class="section-block">
                                    <h3 class="block-title">Pros</h3>
                                    <div class="row">
                                       <div class="col-md-8 col-12">
                                          <ul>
                                             <li>Quick Helm install</li>
                                             <li>CSR approval process is simple</li>
                                             <li>Drop in for clients using Postgres</li>
                                             <li>Insecure setup is very quick</li>
                                          </ul>
                                       </div>
                                    </div>
                                </div>
                                <div id="evaluation-cons"  class="section-block">
                                    <h3 class="block-title">Cons</h3>
                                    <div class="row">
                                       <div class="col-md-8 col-12">
                                          <ul>
                                             <li>Pods still crash after approving CSRs*</li>
                                             <li>Requiring client certificates</li>
                                             <li>Resource intensive</li>
                                          </ul>
                                       </div>
                                    </div>
                                    <p>
                                       <em>* possibly a typo or missing step I am repeating over and over again...</em>
                                    </p>
                                 </div>

                           </section>

                           <a name="references"></a>
                            <section id="reference-section" class="doc-section">
                                <h2 class="section-title">References</h2>

                                <div id="reference-general" class="section-block">
                                 <div class="row">
                                    <div class="col-md-10 col-12">
                                       <ul>
                                          <li><a href="https://kubernetes.io/">kubernetes.io</a></li>
                                          <li><a href="https://helm.sh">helm.sh</a></li>
                                          <li><a href="https://fluxcd.io">fluxcd.io</a></li>
                                          <li><a href="https://github.com/fluxcd/helm-operator">github.com/fluxcd/helm-operator</a></li>
                                          <li><a href="https://brew.sh">brew.sh</a></li>
                                       </ul>
                                    </div>
                                 </div>
                              </div>

                                <div id="reference-cockroach" class="section-block">
                                   <h3>Cockroach references</h3>
                                   <div class="row">
                                    <div class="col-md-10 col-12">
                                       <ul>
                                          <li><a href="https://www.cockroachlabs.com/product/">cockroachlabs.com/product/</a></li>
                                          <li><a href="https://www.cockroachlabs.com/docs/v19.2/install-cockroachdb.html">cockroachlabs.com/.../install-cockroachdb.html</a></li>
                                          <li><a href="https://www.cockroachlabs.com/docs/v19.2/orchestrate-a-local-cluster-with-kubernetes.htm">cockroachlabs.com/.../orchestrate-a-local-cluster-with-kubernetes.htm</a></li>
                                          <li><a href="https://github.com/cockroachdb/cockroach/tree/master/cloud/kubernetes">github.com/cockroachdb/cockroach/.../cloud/kubernetes</a></li>
                                       </ul>
                                    </div>
                                 </div>

                                <div id="reference-provider" class="section-block">
                                   <h3>Kubernetes providers and setups</h3>
                                   <div class="row">
                                      <div class="col-md-10 col-12">
                                         <ul>
                                             <li>AKS by Microsoft Azure:<br/>
                                                <a href="https://azure.microsoft.com/en-us/services/kubernetes-service/">azure.microsoft.com/en-us/services/kubernetes-service/</a></li>
                                             <li>DOKS by DigitalOcean:<br />
                                                <a href="https://www.digitalocean.com/products/kubernetes/">digitalocean.com/products/kubernetes/</a></li>
                                             <li>EKS by Amazon AWS:<br />
                                                <a href="https://aws.amazon.com/eks/">aws.amazon.com/eks/</a></li>
                                             <li>GKE by Google Cloud:<br />
                                                <a href="https://cloud.google.com/kubernetes-engine/">cloud.google.com/kubernetes-engine/</a></li>
                                             <li>OpenShift by Red Hat:<br />
                                                <a href="https://www.openshift.com/">openshift.com</a></li>
                                             <li>RKE by Rancher:<br />
                                                <a href="https://rancher.com/products/rke/">rancher.com/products/rke/</a></li>
                                             <li>Triton by Joyent:<br />
                                                <a href="https://www.joyent.com/triton/kubernetes">joyent.com/triton/kubernetes</a></li>
                                             <li>Docker Enterprise by Mirantis:<br />
                                                <a href="https://www.mirantis.com/software/docker/docker-enterprise/">mirantis.com/software/docker/docker-enterprise/</a></li>
                                             <li><em>Kubernetes the hard way</em>:<br />
                                                <a href="https://github.com/kelseyhightower/kubernetes-the-hard-way">github.com/kelseyhightower/kubernetes-the-hard-way</a></li>
                                       </ul>
                                     </div>
                                  </div>
                               </div>
                               <div id="reference-provider-cli" class="section-block">
                                   <h3>Provider CLI</h3>
                                    <p>
                                       If using a cloud provider,
                                       their CLI usually makes managing the cluster
                                       a lot easier.
                                    </p>
                                    <div class="row">
                                       <div class="col-md-10 col-12">
                                          <ul>
                                             <li>
                                                <div class="code-block">
                                                   <h6><a href="https://github.com/Azure/azure-cli">azure-cli</a> for AKS</h6>
                                                   <pre><code class="language-bash">brew install azure-cli</code></pre>
                                                </div>
                                             </li>
                                             <li>
                                                <div class="code-block">
                                                   <h6><a href="https://github.com/digitalocean/doctl">doctl</a> for DOKS</h6>
                                                   <pre><code class="language-shell">brew install doctl</code></pre>
                                                </div>
                                             </li>
                                             <li>
                                                <div class="code-block">
                                                   <h6><a href="https://eksctl.io">eksctl</a> for EKS</h6>
                                                   <pre><code class="language-bash">brew tap weaveworks/tap;
brew install weaveworks/tap/eksctl</code></pre>
                                                </div>
                                             </li>
                                             <li>
                                                <div class="code-block">
                                                   <h6><a href="https://cloud.google.com/sdk/">gcloud</a> for GKE</h6>
                                                   <pre><code class="language-bash">brew install google-cloud-sdk</code></pre>
                                                </div>
                                             </li>
                                          </ul>
                                       </div>
                                    </div>
                               </div>

                               <div id="reference-guide" class="section-block">
                                    <h3>Kubernetes guides</h3>
                                    <p>By <a href="https://flurdy.com">Flurdy</a></p>
                                    <div class="row">
                                       <div class="col-md-10 col-12">
                                          <ul>
                                             <li><a href="https://flurdy.com/docs/kubernetes/kubernetes-101.html">Kubernetes 101</a></li>
                                             <li><a href="https://flurdy.com/docs/kubernetes/kubernetes-ingress-tls-helm.html">Kubernetes Ingress and TLS</a></li>
                                             <li><a href="https://github.com/flurdy/lemmings/">Kubernetes configuration with GitOps</a></li>
                                             <li><a href="https://flurdy.com/docs/kubernetes/registry/kubernetes-docker-registry.html">Kubernetes Docker registries cookbook</a></li>
                                          </ul>
                                       </div>
                                    </div>
                                 </div>

                           </section>

                           <a name="feedback"></a>
                            <section id="feedback-section" class="doc-section">
                               <h2 class="section-title">Feedback</h2>
                               <div class="section-block">
                                  <div class="row">
                                    <div class="col-md-8 col-12">
                                        <ul>
                                          <li>Feedback: <a href="https://flurdy.com/contact/">flurdy.com/contact/</a></li>
                                          <li>Help: <a href="https://github.com/flurdy/flurdy.com-docs">github.com/flurdy/flurdy.com-docs</a></li>
                                          <li>Sponsor: <a href="https://www.patreon.com/flurdy">patreon.com/flurdy</a></li>
                                          <li>Hire: <a href="https://eray.uk">eray.uk</a></li>
                                          <li>Docs: <a href="https://flurdy.com/docs">flurdy.com/docs</a></li>
                                          <li>Rants: <a href="https://blog.flurdy.com">blog.flurdy.com</a></li>
                                          <li>Moans: <a href="https://flurdy.com/docs">@flurdy</a></li>
                                       </ul>
                                    </div>
                                 </div>
                              </div>
                           </section>

                            <section id="license-section" class="doc-section">
                                <h2 class="section-title">License</h2>
                                <div class="section-block">
                                    <div class="row">
                                       <div class="col-md-2">
                                          <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License"
                                                style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a>
                                       </div>
                                       <div class="col-md-10">
                                          This work is licensed under a<br/>
                                          <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike
                                          4.0 International License</a>.
                                       </div>
                                    </div>
                                 </div>
                           </section>

                        </div>
                    </div>

                    <div class="doc-sidebar col-md-3 col-12 order-0 d-none d-md-flex">
                        <div id="doc-nav" class="doc-nav">
	                            <nav id="doc-menu" class="nav doc-menu flex-column sticky">
	                                <a class="nav-link scrollto" href="#synopsis-section">What is this?</a>
	                                <a class="nav-link scrollto" href="#cockroach-section">CockroachDB</a>
                                    <nav class="doc-sub-menu nav flex-column">
                                        <a class="nav-link scrollto" href="#cockroach-what">What is CockroachDB</a>
                                        <a class="nav-link scrollto" href="#cockroach-why">Why CockroachDB</a>
                                    </nav>
	                                <a class="nav-link scrollto" href="#prerequisite-section">Pre-requisite</a>
                                    <nav class="doc-sub-menu nav flex-column">
                                        <a class="nav-link scrollto" href="#pre-k8s">Kubernetes cluster</a>
                                        <a class="nav-link scrollto" href="#pre-kubectl">Kubernetes CLI</a>
                                        <a class="nav-link scrollto" href="#pre-helm">Helm</a>
                                        <a class="nav-link scrollto" href="#pre-flux">FluxCD</a>
                                    </nav><!--//nav-->
	                                <a class="nav-link scrollto" href="#install-section">Install</a>
                                    <nav class="doc-sub-menu nav flex-column">
                                        <a class="nav-link scrollto" href="#install-helm">Via Helm</a>
                                        <a class="nav-link scrollto" href="#install-flux">FluxCD &amp; Helm</a>
                                        <a class="nav-link scrollto" href="#install-pods">Pods and volumes</a>
                                        <a class="nav-link scrollto" href="#install-certs">Node certificates</a>
                                    </nav>
	                                <a class="nav-link scrollto" href="#database-section">Database setup</a>
                                    <nav class="doc-sub-menu nav flex-column">
                                        <a class="nav-link scrollto" href="#database-connect">Root connection</a>
                                        <a class="nav-link scrollto" href="#database-create">Create database, user and grants</a>
                                    </nav>
	                                <a class="nav-link scrollto" href="#client-section">Clients</a>
                                    <nav class="doc-sub-menu nav flex-column">
                                        <a class="nav-link scrollto" href="#client-certs">Client pod certificates</a>
                                        <a class="nav-link scrollto" href="#client-connection">Database connection</a>
                                    </nav>
	                                <a class="nav-link scrollto" href="#evaluation-section">Evaluation</a>
                                    <nav class="doc-sub-menu nav flex-column">
                                        <a class="nav-link scrollto" href="#evaluation-pros">Pros</a>
                                        <a class="nav-link scrollto" href="#evaluation-cons">Cons</a>
                                    </nav>
	                                <a class="nav-link scrollto" href="#reference-section">References</a>
                                    <nav class="doc-sub-menu nav flex-column">
                                        <a class="nav-link scrollto" href="#reference-cockroach">Cockroach references</a>
                                        <a class="nav-link scrollto" href="#reference-provider">Kubernetes providers</a>
                                        <a class="nav-link scrollto" href="#reference-provider-cli">Provider CLI</a>
                                        <a class="nav-link scrollto" href="#reference-guide">Kubernetes guides</a>
                                    </nav>
	                                <a class="nav-link scrollto" href="#feedback-section">Feedback</a>
                                   <a class="nav-link scrollto" href="#license-section">License</a>
                                   <nav class="doc-sub-menu nav flex-column">
                                      <div class="license">
                                        <a href="http://creativecommons.org/licenses/by-sa/4.0/"><img src="/images/cc-by-sa-small.png" alt="cc by-sa"
                                           title="Creative Commons Attributions-ShareAlike" border="0" /\></a>
                                      </div>
                                   </nav>
	                            </nav>

                           </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

   <footer id="footer" class="footer text-center">
      <div class="container">
         <!--/* This template is released under the Creative Commons Attribution 3.0 License. Please keep the attribution link below when using for your own project. Thank you for your support. :) If you'd like to use the template without the attribution, you can buy the commercial license via our website: themes.3rdwavemedia.com */-->
         <small class="copyright">Designed with <i class="fas fa-heart"></i> by <a href="https://themes.3rdwavemedia.com/"
               target="_blank">Xiaoying Riley</a> for developers</small>

      </div>
   </footer>


   <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
      rel='stylesheet' type='text/css'>
    <script type="text/javascript" src="assets/plugins/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="assets/plugins/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="assets/plugins/prism/prism.js"></script>
    <script type="text/javascript" src="assets/plugins/jquery-scrollTo/jquery.scrollTo.min.js"></script>
    <script type="text/javascript" src="assets/plugins/stickyfill/dist/stickyfill.min.js"></script>
    <script type="text/javascript" src="assets/js/main.js"></script>

</body>
</html>
